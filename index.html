<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Mass & Balance Dornier 228</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="design.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d0d0d">
  <link rel="apple-touch-icon" href="icone.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="D228">

  <!-- Scripts iniciais -->
  <script src="app-version.js"></script>
  <script defer src="auto-update.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('SW registado'))
        .catch(err => console.error('Erro SW:', err));
    }
  </script>
</head>
<body>

  <!-- Link para Settings -->
  <div class="settings-link">
    <a href="settings.html">⚙️ Settings</a>
  </div>

  <!-- Dropdown de Rotas -->
  <div style="text-align:center;margin:20px 0;">
    <select id="dropdownRotas">
      <option value="">-- Selecionar rota --</option>
    </select>
  </div>

  <!-- Tabela de Legs -->
  <table id="legsTable" class="route-table">
    <thead>
      <tr>
        <th>Leg</th>
        <th>Depf(lb)</th>
        <th>Payl(kg)</th>
        <th>Tripf(lb)</th>
        <th>LDG(lb)</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <!-- Linhas criadas dinamicamente -->
    </tbody>
  </table>

  <!-- Scripts de lógica -->
  <script>
    // Preenche o dropdown de rotas com os dados de rotasPadrao
    function carregarDropdownRotas() {
      const rotas = JSON.parse(localStorage.getItem('rotasPadrao') || '[]');
      const dd = document.getElementById('dropdownRotas');
      dd.innerHTML = '<option value="">-- Selecionar rota --</option>';
      rotas.forEach((r,i) => {
        const o = document.createElement('option');
        o.value = i; o.text = r.nome;
        dd.appendChild(o);
      });
    }

    // Cria uma linha na tabela de legs
    function criarLinhaLeg(route = '', depF = '', payl = '', tripF = '') {
      const tbody = document.querySelector('#legsTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true" class="rota-edit">${route}</td>
        <td><input type="number" value="${depF}" /></td>
        <td><input type="number" value="${payl}" /></td>
        <td><input type="number" value="${tripF}" /></td>
        <td class="ldg-cell"></td>
        <td><button class="del-leg">×</button></td>
      `;
      tbody.appendChild(tr);
      // adiciona event listeners (editar, calcular LDG, apagar)
      // … aqui vai o teu código existente …
    }

    // Guarda no localStorage as edições em legsTable
    function guardarLegs() {
      const rows = [...document.querySelectorAll('#legsTable tbody tr')];
      const dados = rows.map(r => ({
        route: r.cells[0].innerText.trim(),
        depF:  r.cells[1].querySelector('input').value,
        payl:  r.cells[2].querySelector('input').value,
        tripF: r.cells[3].querySelector('input').value
      }));
      localStorage.setItem('legsAtuais', JSON.stringify(dados));
    }

    // Carrega as linhas ao arrancar a app
    function carregarLegs() {
      const dados = JSON.parse(localStorage.getItem('legsAtuais') || '[]');
      const tbody = document.querySelector('#legsTable tbody');
      tbody.innerHTML = '';
      if (dados.length === 0) {
        for (let i=0;i<5;i++) criarLinhaLeg();
      } else {
        dados.forEach(d => criarLinhaLeg(d.route,d.depF,d.payl,d.tripF));
      }
    }

    // Preenche a tabela a partir da rota selecionada
    function preencherLegsComRota() {
      const idx = document.getElementById('dropdownRotas').value;
      const rotas = JSON.parse(localStorage.getItem('rotasPadrao') || '[]');
      const tbody = document.querySelector('#legsTable tbody');
      tbody.innerHTML = '';
      if (idx === '') {
        for (let i=0;i<5;i++) criarLinhaLeg();
        localStorage.removeItem('legsAtuais');
        return;
      }
      const rota = rotas[idx];
      rota.legs.forEach(l => criarLinhaLeg(l.route,l.depF,l.payl,l.tripF));
      localStorage.setItem('legsAtuais', JSON.stringify(rota.legs));
    }

    // Renderiza a tabela (caso uses uma função separada)
    function renderTabela(dados) {
      const tbody = document.querySelector('#legsTable tbody');
      tbody.innerHTML = '';
      dados.forEach(d => criarLinhaLeg(d.route,d.depF,d.payl,d.tripF));
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      carregarDropdownRotas();
      carregarLegs();

      // Listener: só dispara quando trocas de rota
      document.getElementById('dropdownRotas')
        .addEventListener('change', () => {
          localStorage.removeItem('legsAtuais');
          preencherLegsComRota();
          renderTabela(JSON.parse(localStorage.getItem('legsAtuais')||'[]'));
        });

      // Substitui ícones
      feather.replace();

      // Aqui adiciona o resto dos listeners (inputs, cálculo, etc.)
      // … o teu código de calculate(), convertKgToLb(), updateLdgAuto(), etc. …
    });
  </script>

</body>
</html>
